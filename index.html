<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Atlas Visualizer</title>
    <style>
    :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --accent: #38bdf8;
        --background: linear-gradient(135deg, rgba(241,245,249,0.7), rgba(219,234,254,0.7));
        --surface: rgba(255,255,255,0.55);
        --surface-strong: rgba(255,255,255,0.7);
        --border: rgba(224,231,239,0.7);
        --text: #0f172a;
        --muted: #475569;
        --shadow: 0 8px 30px rgba(30, 64, 175, 0.12), 0 2px 8px rgba(30, 64, 175, 0.08);
        --radius: 16px;
        --blur: 16px;
        --transition: 220ms cubic-bezier(0.22, 1, 0.36, 1);
        --ring: 0 0 0 4px rgba(37, 99, 235, 0.15);
    }

    * { box-sizing: border-box; }

    body {
        font-family: 'Segoe UI', 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        background: var(--background);
        background-attachment: fixed;
        color: var(--text);
        min-height: 100vh;
    }

    .container {
        max-width: 1200px;
        margin: 40px auto 40px auto;
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 36px 32px 32px 32px;
        position: relative;
        border: 1px solid var(--border);
        -webkit-backdrop-filter: blur(var(--blur));
        backdrop-filter: blur(var(--blur));
        transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
    }
    .container:hover { transform: translateY(-1px); box-shadow: 0 16px 48px rgba(30,64,175,0.16); }

    h1 {
        color: var(--primary);
        font-size: 2.2rem;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
        text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }

    p {
        color: var(--muted);
        margin-bottom: 24px;
        font-size: 1.02rem;
    }

    .controls {
        margin: 22px 0 16px 0;
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
    }

    input[type="file"] {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--surface-strong);
        color: var(--text);
        font-size: 0.98rem;
        transition: border var(--transition), box-shadow var(--transition), background var(--transition), transform var(--transition);
        outline: none;
        -webkit-backdrop-filter: blur(var(--blur));
        backdrop-filter: blur(var(--blur));
    }

    input[type="file"]:hover { transform: translateY(-1px); box-shadow: var(--ring); }
    input[type="file"]:focus { border: 1.5px solid var(--primary); box-shadow: var(--ring); }

    button {
        padding: 10px 20px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 0.98rem;
        font-weight: 600;
        cursor: pointer;
        transition: background var(--transition), transform var(--transition);
    }

    button:hover, button:focus {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    button:active {
        transform: translateY(0);
    }

    #error {
        color: #ef4444;
        margin-top: 8px;
        font-size: 1rem;
        min-height: 24px;
        text-align: center;
        text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }

    /* Glass notification */
    .notify {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 360px;
        padding: 14px 16px;
        border-radius: 16px;
        background: rgba(255,255,255,0.5);
        -webkit-backdrop-filter: blur(18px);
        backdrop-filter: blur(18px);
        border: 1px solid rgba(224,231,239,0.7);
        box-shadow: 0 16px 48px rgba(30,64,175,0.18);
        color: #0f172a;
        z-index: 2000;
        display: none;
        transition: opacity var(--transition), transform var(--transition);
        opacity: 0;
        transform: translateY(-8px);
    }
    .notify.show { display: block; opacity: 1; transform: translateY(0); }
    .notify-title { font-weight: 800; color: #ef4444; margin-bottom: 6px; letter-spacing: -0.2px; }
    .notify-text { font-size: 0.96rem; color: #334155; }
    .notify-list { margin: 8px 0 0 0; padding-left: 16px; font-size: 0.92rem; color: #475569; max-height: 180px; overflow: auto; }

    canvas {
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        max-width: 100%;
        margin-top: 18px;
        margin-bottom: 18px;
        display: block;
        -webkit-backdrop-filter: blur(var(--blur));
        backdrop-filter: blur(var(--blur));
    }

    /* Thumbnails grid */
    .thumb-grid {
        margin-top: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 18px;
    }

    .thumb-item {
        perspective: 1200px;
        min-height: 240px;
    }

    .thumb-card {
        position: relative;
        width: 100%;
        height: 240px;
        transform-style: preserve-3d;
        transition: transform var(--transition), box-shadow var(--transition);
        cursor: pointer;
    }

    .thumb-card.is-flipped {
        transform: rotateY(180deg);
    }

    .thumb-face {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px;
        background: var(--surface-strong);
        box-shadow: 0 6px 18px rgba(30, 64, 175, 0.08);
        backface-visibility: hidden;
        overflow: hidden;
        -webkit-backdrop-filter: blur(var(--blur));
        backdrop-filter: blur(var(--blur));
    }

    .thumb-item:hover .thumb-face { box-shadow: 0 10px 28px rgba(30,64,175,0.14); }

    .thumb-front canvas {
        border-radius: 10px;
        border: 1px dashed rgba(37,99,235,0.6);
        width: 100%;
        height: 140px;
        object-fit: contain;
        background: rgba(255,255,255,0.6);
    }

    .thumb-caption {
        margin-top: 8px;
        font-size: 0.9rem;
        color: var(--text);
        text-align: center;
        word-break: break-word;
        font-weight: 700;
        letter-spacing: -0.2px;
        line-height: 1.2;
        max-height: 2.4em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }

    .thumb-back {
        transform: rotateY(180deg);
        align-items: stretch;
        gap: 6px;
        padding: 10px 12px;
        overflow: auto;
    }

    .kv {
        display: flex;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--muted);
        width: 100%;
        line-height: 1.2;
        word-break: break-word;
    }
    .kv .k { color: var(--primary-dark); min-width: 78px; font-weight: 700; }
    .kv .v { color: var(--muted); }

    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced Atlas Visualizer</h1>
        <p>Upload a .atlas file and corresponding .png/.jpg images to visualize each region as flip cards.</p>
        
        <div class="controls">
            <input type="file" id="atlasFile" accept=".atlas,.txt" />
            <input type="file" id="pngFile" accept=".png,.jpg,.jpeg" multiple />
            <button onclick="visualize()">Visualize</button>
            <button onclick="clearCanvas()">Clear</button>
        </div>
        
        <div id="error"></div>
        <canvas id="canvas" style="display:none"></canvas>
        
        <div id="infoBox" style="display:none">
            <div class="info-title">Object Details</div>
            <div id="infoContent"></div>
        </div>
        
        <div id="thumbGrid" class="thumb-grid"></div>
    </div>

    <div id="notify" class="notify" role="alert" aria-live="polite"></div>

    <script>
        let objects = [];
        let canvas, ctx;
        let img = null;
        let hoveredObject = null;
        let imageMap = new Map();

        function parseAtlas(atlasText) {
            const parsedObjects = [];
            let currentObject = null;
            let currentPage = null;
            const lines = atlasText.split('\n').map(line => line.trim());

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (!line) continue;

                if (line.match(/\.(png|jpg|jpeg)$/i)) {
                    currentPage = line.split(/[\\\/]/).pop();
                    continue;
                }
                if (!line.includes(':') && line !== 'repeat: none' && !line.startsWith('size') && !line.startsWith('format') && !line.startsWith('filter')) {
                    currentObject = { name: line, page: currentPage };
                    parsedObjects.push(currentObject);
                } else if (currentObject && line.includes(':')) {
                    const [k, v] = line.split(':');
                    const key = k.trim();
                    const value = v.trim();
                    if (key === 'rotate') {
                        currentObject.rotate = value === 'true';
                    } else if (key === 'xy') {
                        const [x, y] = value.split(',').map(Number);
                        currentObject.xy = { x, y };
                    } else if (key === 'size') {
                        const [width, height] = value.split(',').map(Number);
                        currentObject.size = { width, height };
                    } else if (key === 'orig') {
                        const [origWidth, origHeight] = value.split(',').map(Number);
                        currentObject.orig = { width: origWidth, height: origHeight };
                    } else if (key === 'offset') {
                        const [offsetX, offsetY] = value.split(',').map(Number);
                        currentObject.offset = { x: offsetX, y: offsetY };
                    } else if (key === 'index') {
                        currentObject.index = Number(value);
                    }
                }
            }
            return parsedObjects;
        }

        function renderThumbnails() {
            const grid = document.getElementById('thumbGrid');
            grid.innerHTML = '';
            if (!objects.length) return;

            objects.forEach(obj => {
                if (!obj.xy || !obj.size || !obj.page) return;
                const sourceImg = imageMap.get((obj.page || '').split(/[\\\/]/).pop());
                if (!sourceImg) return;

                const { x, y } = obj.xy;
                const { width, height } = obj.size;

                const thumbCanvas = document.createElement('canvas');
                const thumbCtx = thumbCanvas.getContext('2d');
                thumbCanvas.width = width;
                thumbCanvas.height = height;

                if (obj.rotate) {
                    thumbCanvas.width = width;
                    thumbCanvas.height = height;
                    thumbCtx.save();
                    thumbCtx.translate(width / 2, height / 2);
                    thumbCtx.rotate(-Math.PI / 2);
                    thumbCtx.drawImage(
                        sourceImg,
                        x, y, height, width,
                        -height / 2, -width / 2, height, width
                    );
                    thumbCtx.restore();
                } else {
                    thumbCtx.drawImage(sourceImg, x, y, width, height, 0, 0, width, height);
                }

                const item = document.createElement('div');
                item.className = 'thumb-item';
                const card = document.createElement('div');
                card.className = 'thumb-card';

                const front = document.createElement('div');
                front.className = 'thumb-face thumb-front';
                front.appendChild(thumbCanvas);
                const caption = document.createElement('div');
                caption.className = 'thumb-caption';
                caption.textContent = obj.name;
                front.appendChild(caption);

                const back = document.createElement('div');
                back.className = 'thumb-face thumb-back';
                back.innerHTML = `
                    <div class="thumb-caption" style="font-size:0.85rem;font-weight:700;">${obj.page}</div>
                    ${obj.xy ? `<div class=\"kv\"><div class=\"k\">Position</div><div class=\"v\">${obj.xy.x}, ${obj.xy.y}</div></div>` : ''}
                    ${obj.size ? `<div class=\"kv\"><div class=\"k\">Size</div><div class=\"v\">${obj.size.width} x ${obj.size.height}</div></div>` : ''}
                    ${obj.orig ? `<div class=\"kv\"><div class=\"k\">Original</div><div class=\"v\">${obj.orig.width} x ${obj.orig.height}</div></div>` : ''}
                    ${obj.offset ? `<div class=\"kv\"><div class=\"k\">Offset</div><div class=\"v\">${obj.offset.x}, ${obj.offset.y}</div></div>` : ''}
                    ${obj.rotate ? `<div class=\"kv\"><div class=\"k\">Rotated</div><div class=\"v\">Yes (90°)</div></div>` : ''}
                    ${obj.index !== undefined ? `<div class=\"kv\"><div class=\"k\">Index</div><div class=\"v\">${obj.index}</div></div>` : ''}
                `;

                card.appendChild(front);
                card.appendChild(back);
                item.appendChild(card);

                item.addEventListener('click', () => {
                    card.classList.toggle('is-flipped');
                });

                grid.appendChild(item);
            });
        }

        async function loadSelectedImagesAsMap(fileList) {
            imageMap.clear();
            const files = Array.from(fileList || []);
            const allowed = new Set(['png','jpg','jpeg']);
            const bad = files.filter(f => !allowed.has((f.name.split('.').pop() || '').toLowerCase()));
            if (bad.length) {
                throw new Error('Only .png/.jpg images are supported.');
            }
            const readAsDataURL = (file) => new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => resolve({ name: file.name, url: fr.result });
                fr.onerror = reject;
                fr.readAsDataURL(file);
            });
            const entries = await Promise.all(files.map(readAsDataURL));
            const loadImage = (name, url) => new Promise((resolve, reject) => {
                const image = new Image();
                image.onload = () => resolve({ name, image });
                image.onerror = reject;
                image.src = url;
            });
            const results = await Promise.all(entries.map(e => loadImage(e.name, e.url)));
            results.forEach(({ name, image }) => {
                const key = name.split(/[\\\/]/).pop();
                imageMap.set(key, image);
            });
        }

        function showNotificationMissing(missingList) {
            const notify = document.getElementById('notify');
            if (!missingList || !missingList.length) {
                notify.classList.remove('show');
                notify.innerHTML = '';
                return;
            }
            const listItems = missingList.map(fn => `<li>${fn}</li>`).join('');
            notify.innerHTML = `
                <div class="notify-title">Missing images</div>
                <div class="notify-text">The atlas references image page(s) that were not uploaded:</div>
                <ul class="notify-list">${listItems}</ul>
            `;
            notify.classList.add('show');
        }

        function visualize() {
            const atlasInput = document.getElementById('atlasFile');
            const imagesInput = document.getElementById('pngFile');
            const atlasFile = atlasInput.files[0];
            const pngFiles = imagesInput.files;
            const errorDiv = document.getElementById('error');
            
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            errorDiv.textContent = '';

            if (!atlasFile) {
                errorDiv.textContent = 'Please select an .atlas file first.';
                return;
            }
            const atlasExt = (atlasFile.name.split('.').pop() || '').toLowerCase();
            if (!['atlas','txt'].includes(atlasExt)) {
                errorDiv.textContent = 'Invalid atlas file. Accepted: .atlas or .txt';
                return;
            }
            if (!pngFiles || pngFiles.length === 0) {
                errorDiv.textContent = 'Please select one or more .png/.jpg images.';
                return;
            }

            const atlasReader = new FileReader();
            atlasReader.onload = async function (e) {
                try {
                    const atlasText = e.target.result;
                    objects = parseAtlas(atlasText);
                    await loadSelectedImagesAsMap(pngFiles);

                    const referencedPages = Array.from(new Set(objects.map(o => (o.page || '').split(/[\\\/]/).pop()).filter(Boolean)));
                    const uploadedPages = new Set(Array.from(imageMap.keys()));
                    const missing = referencedPages.filter(p => !uploadedPages.has(p));
                    showNotificationMissing(missing);

                    const firstImg = imageMap.values().next().value || null;
                    img = firstImg || null;
                    if (img) {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    }

                    renderThumbnails();
                } catch (err) {
                    console.error(err);
                    errorDiv.textContent = err && err.message ? err.message : 'Error processing files. Ensure atlas format and images are valid.';
                }
            };
            atlasReader.onerror = function () {
                errorDiv.textContent = 'Error loading atlas file. Ensure it\'s a valid .atlas file.';
            };
            atlasReader.readAsText(atlasFile);
        }

        function clearCanvas() {
            if (canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            objects = [];
            img = null;
            imageMap.clear();
            hoveredObject = null;
            const grid = document.getElementById('thumbGrid');
            grid.innerHTML = '';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '';
            const notify = document.getElementById('notify');
            notify.classList.remove('show');
            notify.innerHTML = '';
        }
    </script>
</body>
</html>
